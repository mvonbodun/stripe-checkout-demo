<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddressElement Fix Verification</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 20px;
            background: #f8fafc;
        }
        .test-container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px;
        }
        .success { border-color: #10b981; background: #f0fdf4; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        .error { border-color: #ef4444; background: #fef2f2; }
        button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #2563eb; }
        .iframe-list {
            background: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background: #10b981; }
        .status-fail { background: #ef4444; }
        .status-pending { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 AddressElement Fix Verification</h1>
        <p>This page helps verify that the AddressElement disappearing bug has been fixed.</p>
        
        <div class="test-section">
            <h2>🎯 Test Scenario</h2>
            <p>The bug: When users interact with the LinkAuthenticationElement (email field), the AddressElement would disappear, breaking the checkout flow.</p>
            <p><strong>Expected behavior after fix:</strong> AddressElement should remain visible and functional after email interactions.</p>
        </div>

        <div class="test-section" id="cart-status">
            <h2>🛒 Cart Status</h2>
            <p>First, add items to your cart:</p>
            <button onclick="addTestItems()">Add Test Items to Cart</button>
            <button onclick="window.open('/checkout', '_blank')">Open Checkout Page</button>
            <div id="cart-info"></div>
        </div>

        <div class="test-section" id="test-controls">
            <h2>🧪 Automated Tests</h2>
            <button onclick="runElementVisibilityTest()">Test Element Visibility</button>
            <button onclick="runEmailInteractionTest()">Test Email Interaction</button>
            <button onclick="runFullIntegrationTest()">Run Full Integration Test</button>
            <div id="test-results"></div>
        </div>

        <div class="test-section" id="manual-testing">
            <h2>📋 Manual Testing Steps</h2>
            <ol>
                <li>Open the checkout page in a new tab</li>
                <li>Wait for Stripe Elements to load</li>
                <li>Verify that both LinkAuthenticationElement (email) and AddressElement are visible</li>
                <li>Enter an email address in the email field</li>
                <li>Complete the email validation</li>
                <li><strong>Critical:</strong> Verify that the AddressElement is still visible and functional</li>
                <li>Try entering an address to confirm it works</li>
            </ol>
        </div>

        <div class="test-section" id="debugging-info">
            <h2>🔍 Debug Information</h2>
            <button onclick="inspectStripeElements()">Inspect Stripe Elements</button>
            <button onclick="checkConsoleMessages()">Check Console Messages</button>
            <div id="debug-output"></div>
        </div>
    </div>

    <script>
        // Add test items to cart
        function addTestItems() {
            const testItems = [
                {
                    product_id: 1,
                    name: "Test Product 1",
                    price: 29.99,
                    quantity: 1,
                    image: "/next.svg",
                    attributes: ["Size: M", "Color: Blue"],
                    taxcode: "txcd_99999999"
                },
                {
                    product_id: 2,
                    name: "Test Product 2", 
                    price: 49.99,
                    quantity: 2,
                    image: "/vercel.svg",
                    attributes: ["Size: L"],
                    taxcode: "txcd_99999999"
                }
            ];

            testItems.forEach(item => {
                window.dispatchEvent(new CustomEvent('addToCart', { detail: item }));
            });
            
            document.getElementById('cart-info').innerHTML = '✅ Test items added to cart. Now open the checkout page.';
            console.log('✅ Added test items to cart');
        }

        // Inspect Stripe Elements
        function inspectStripeElements() {
            const checkoutWindow = window.open('/checkout', 'checkout-test');
            
            setTimeout(() => {
                try {
                    const iframes = checkoutWindow.document.querySelectorAll('iframe');
                    const elements = Array.from(iframes).map((iframe, index) => ({
                        index,
                        title: iframe.title || 'No title',
                        src: iframe.src || 'No src',
                        visible: iframe.offsetWidth > 0 && iframe.offsetHeight > 0,
                        width: iframe.offsetWidth,
                        height: iframe.offsetHeight
                    }));
                    
                    const output = document.getElementById('debug-output');
                    output.innerHTML = '<h3>Stripe Elements Found:</h3><div class="iframe-list">' + 
                        JSON.stringify(elements, null, 2) + '</div>';
                        
                    console.log('Stripe Elements inspection:', elements);
                } catch (error) {
                    document.getElementById('debug-output').innerHTML = 
                        '<p class="error">Cannot inspect checkout window (CORS/security). Open devtools on checkout page instead.</p>';
                }
            }, 3000);
        }

        // Run element visibility test
        function runElementVisibilityTest() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<p>🔄 Running element visibility test...</p>';
            
            // This test needs to run in the context of the checkout page
            const testScript = `
                const linkAuthIframes = document.querySelectorAll('iframe[title*="email"], iframe[name*="link"], iframe[title*="Link Authentication"]');
                const addressIframes = document.querySelectorAll('iframe[title*="address"], iframe[title*="Address"], iframe[name*="address"]');
                const allIframes = document.querySelectorAll('iframe');
                
                console.log('Element Visibility Test Results:', {
                    totalIframes: allIframes.length,
                    linkAuthElements: linkAuthIframes.length,
                    addressElements: addressIframes.length,
                    allTitles: Array.from(allIframes).map(f => f.title)
                });
                
                return {
                    linkAuthFound: linkAuthIframes.length > 0,
                    addressFound: addressIframes.length > 0,
                    totalElements: allIframes.length
                };
            `;
            
            results.innerHTML = '<p>📝 Test script prepared. Execute in checkout page console:</p><code>' + testScript + '</code>';
        }

        // Check console messages
        function checkConsoleMessages() {
            const output = document.getElementById('debug-output');
            output.innerHTML = `
                <h3>🔍 Console Monitoring Instructions:</h3>
                <p>Open the checkout page and monitor the console for these key messages:</p>
                <ul>
                    <li><code>🚀 CheckoutForm component mounted</code> - Component loaded</li>
                    <li><code>📧 LinkAuthentication changed</code> - Email interaction detected</li>
                    <li><code>🏠 AddressElement changed</code> - Address element still responsive</li>
                    <li><code>🔑 clientSecret changed</code> - Payment intent updates</li>
                </ul>
                <p><strong>Look for:</strong> No "component unmounting" messages after email interaction!</p>
            `;
        }

        // Run full integration test
        function runFullIntegrationTest() {
            const results = document.getElementById('test-results');
            results.innerHTML = `
                <h3>🎯 Full Integration Test</h3>
                <p><span class="status-indicator status-pending"></span>Opening checkout page...</p>
                <p><span class="status-indicator status-pending"></span>Waiting for Stripe Elements to load...</p>
                <p><span class="status-indicator status-pending"></span>Testing email interaction...</p>
                <p><span class="status-indicator status-pending"></span>Verifying AddressElement persistence...</p>
                
                <div style="margin-top: 20px; padding: 15px; background: #e0f2fe; border-radius: 6px;">
                    <strong>🎯 Manual Verification Required:</strong><br>
                    1. A checkout page should open in a new window<br>
                    2. Enter an email address<br>
                    3. Verify the shipping address section remains visible<br>
                    4. Try entering an address to confirm functionality
                </div>
            `;
            
            // Open checkout page for manual testing
            setTimeout(() => {
                window.open('/checkout', 'integration-test');
            }, 1000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 AddressElement Fix Verification page loaded');
            console.log('📝 Use the buttons above to test the checkout page fix');
        });
    </script>
</body>
</html>
